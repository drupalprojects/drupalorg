<?php

/**
 * Implementation of hook_block().
 */
function drupalorg_order_facet_block($op = 'list', $delta = 0, $edit = array()) {
  static $blocks;
  if (is_null($blocks)) {
    $blocks = array(
      'ds_created' => array(
        'info' => t('New content'),
        'direction' => 'desc',
        'cache' => BLOCK_NO_CACHE,
      ),
      'iss_project_release_usage' => array(
        'info' => t('Most installed'),
        'direction' => 'desc',
        'cache' => BLOCK_NO_CACHE,
      ),
    );
  }

  if ($op === 'list') {
    return $blocks;
  }
  elseif ($op === 'view') {
    $env_id = apachesolr_default_environment();
    if (apachesolr_has_searched($env_id) && ($query = apachesolr_current_query($env_id))) {
      // Replace 'content' with 'Modules', 'Themes', etc.
      foreach ($query->getFilters() as $filter) {
        if ($filter['#name'] === 'im_vid_3') {
          $term = taxonomy_get_term($filter['#value']);
          $blocks[$delta]['info'] = str_replace('content', check_plain($term->name), $blocks[$delta]['info']);
        }
      }
      $results = _drupalorg_order_facet_build($delta, $blocks[$delta], $query);
      if (!empty($results)) {
        return array(
          'subject' => $blocks[$delta]['info'],
          'content' => theme('item_list', $results),
        );
      }
    }
  }
}

/**
 * Generate an order facet.
 */
function _drupalorg_order_facet_build($sort, $info, $query, $count = 4, $more = TRUE) {
  // Generate a new query based on the executed one.
  $order_query = clone $query;
  $order_query->setSolrSort($sort, $info['direction']);

  // Retrieve the query values first so everything is formatted correctly,
  // and we only have relevant values in the url.
  $query_values = $order_query->getSolrsortUrlQuery();
  foreach ($order_query->getFilters() as $filter) {
    $query_values['f'][] = $filter['#name'] . ':' . $filter['#value'];
  }

  // Execute the Solr query.
  $order_query->addParams(array(
    'fl' => 'id,nid,title,url',
    'start' => 0,
    'rows' => $count,
  ));
  $response = $order_query->search();

  $items = array();
  if ($response->response->numFound > 0) {
    foreach ($response->response->docs as $doc) {
      $items[] = l($doc->label, $doc->url);
    }
  }

  if ($items && $more) {
    // Add the "more" link.
    $items[] = array(
      'data' => l(t('More @title', array('@title' => $info['info'])), $order_query->getPath(), array('query' => $query_values)),
      'class' => 'all',
    );
  }
  return $items;
}
