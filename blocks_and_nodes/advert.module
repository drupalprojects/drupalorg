<?php

define('ADVERT_BLOCK_BODY', 'advert_block_body_');

/**
 * List all blocks. This is the only place to add blocks to if you need more.
 */
function _advert_list_blocks() {
  $list = array();

  $list[0]['forum'] = 51;
  $list[0]['title'] = t('Paid services forum ad');

  $list[1]['forum'] = 34;
  $list[1]['title'] = t('Affiliate hosting header ad');

  $list[2]['forum'] = 51;
  $list[2]['title'] = t('Affiliate paid-services Ad with Google Ad Manager');

  return $list;
}

/**
 * Get data for a particular block, by delta
 */
function _advert_get_block($delta) {
  $list = _advert_list_blocks();
  return $list[$delta];
}

/**
 * Implementation of hook_block()
 */
function advert_block($op = 'list', $delta = 0, $edit = array()) {
  switch ($op) {
    case 'list':
      $blocks = array();
      foreach(_advert_list_blocks() as $block_delta => $block_data) {
        $blocks[$block_delta]['info'] = $block_data['title'];
      }
      return $blocks;

    case 'configure':
      $form = array();

      $form[ADVERT_BLOCK_BODY . $delta] = array(
        '#type'          => 'textarea',
        '#title'         => t('HTML and/or Javascript'),
        '#description'   => t('Enter HTML and/or Javascript to display in this block'),
        '#default_value' => variable_get(ADVERT_BLOCK_BODY . $delta, ''),
      );
      return $form;

    case 'save':
      variable_set(ADVERT_BLOCK_BODY . $delta, $edit[ADVERT_BLOCK_BODY . $delta]);
      return;

    case 'view':
      $block_data = _advert_get_block($delta);
      $forum = $block_data['forum'];
      if (advert_is_in_forum($forum)) {
        $block['subject'] = $block_data['title'];
        $block['content'] = variable_get(ADVERT_BLOCK_BODY . $delta, '');
        return $block;
      }
  }
}

/** 
 * Check the visibility of the block, it should be on a forum basis
 */
function advert_is_in_forum($forum_id) {
  if (arg(0) == 'forum' && arg(1) == $forum_id) {
    return TRUE;
  }
  if (arg(0) == 'node' && is_numeric(arg(1))) {
    $node = node_load(arg(1));
    if ($node->type == 'forum' && $node->tid == $forum_id) {
      return TRUE;
    }
  }
  return FALSE;
}

